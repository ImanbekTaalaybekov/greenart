# GreenArt

GreenArt — корпоративная платформа для компании по озеленению, которая работает по подписке и предоставляет отдельные разовые услуги. Цель приложения — связать клиента, сотрудников и административные роли в едином рабочем пространстве, где задачи фиксируются, распределяются между работниками и полностью контролируются администратором и бухгалтерией.

## Роли системы
- **Клиент** — формирует заявку в рамках подписки или вне её, прикладывает текстовое описание и фотографии дополнительных задач.
- **Работник** — получает назначенные задачи, подтверждает готовность взяться за работу, фиксирует прогресс.
- **Администратор** — видит все заявки, управляет назначением исполнителей, контролирует статусы и соответствие SLA.
- **Бухгалтер** — отслеживает способ оплаты, суммы по разовым услугам, подтверждает закрытие финансов.

## Жизненный цикл заказа
1. Клиент отправляет заявку (основной текст + фото доп. задачи).
2. Выбирается `payment_type`:
   - `subscription` — задача входит в пакетные обязательства, поле `payment_money` остаётся `null`;
   - `extra` — услуга оплачивается отдельно, в `payment_money` фиксируется сумма.
3. Администратор назначает исполнителя, заполняя `worker_id`.
4. Работник принимает задачу в работу, обновляет статусы и отчётность.
5. Бухгалтер подтверждает оплату (для `extra`) и закрытие задачи.

В дальнейшем планируется расширить модель заказа (`orders`/`tasks`) дополнительными полями: статус выполнения, дедлайны, история действий и вложения для внутренней коммуникации.

## Поток администратора
- **Объявления**: отдельная лента, где админ размещает новости и регламенты. Экран создания включает `title` и детальное описание, после сохранения карточка появляется в общей ленте.
- **Управление ролями и аккаунтами**: список пользователей, отсортированный по ролям (Админы, Садовники, Клиенты, Бухгалтеры). В карточке роли виден перечень аккаунтов и кнопка перехода к форме редактирования/создания (логин, пароль, выбранная роль, дополнительные поля).
- **Назначение задач**: из списка работников или клиентов админ проваливается в карточку, видит текущее расписание (календарь рабочих/выходных дней), очередь задач и кнопку «назначить». При создании задачи выбираются клиент, адрес, комментарий, прикладываются файлы; после сохранения задача появляется у работника и в отчётах.
- **Коммуникации**: по каждой задаче создаётся чат между нужными ролями (A+W, A+W+K и т.д.). Админ может добавлять/удалять участников, видеть историю, получать подтверждения выполнения. Работник отвечает и прикладывает фотоотчёт, но не меняет состав чата.
- **Ежедневные отчёты**: отдельный экран «Отчёт дня» агрегирует фото, время выполнения, комментарии от работника и клиента. В календаре можно перейти к конкретной дате и открыть связанный отчёт/чат.
- **Финансы**: модуль показывает данные договора, сумму к оплате, комментарии, а также таблицу «История оплат» с разбивкой по месяцам. Админ создаёт новый счёт, отмечает поступление средств и передаёт информацию бухгалтеру.

## API объявлений
### Модель данных
- `announcements`: `title`, `body`, `audience (all|clients|workers)`, `published_at`, `created_by`.
- `announcement_photos`: хранит путь к файлу, оригинальное имя, `mime_type` и размер каждого вложения.
- `announcement_reads`: фиксирует факт прочтения (`read_at`) для пары «объявление + пользователь».

Миграции добавлены в `database/migrations/2025_11_19_*`. После деплоя достаточно выполнить `php artisan migrate`. Для публичной раздачи файлов объявлений требуется симлинк `php artisan storage:link`, потому что загрузки попадают на диск `public` по пути `storage/app/public/announcements/{id}`.

### REST-эндпоинты
| Метод | Путь | Защита | Назначение |
| --- | --- | --- | --- |
| `GET /api/announcements` | `auth:sanctum` | Пагинация всей ленты с флагом `is_read` и вложениями. |
| `GET /api/announcements/{announcement}` | `auth:sanctum` | Детальная карточка объявления с фотографиями. |
| `POST /api/announcements` | `auth:sanctum` + политика `create` | Создание объявления администратором, поддерживает множественную загрузку `photos[]`. |
| `PUT /api/announcements/{announcement}` | `auth:sanctum` + политика `update` | Редактирование текста, даты публикации и добавление новых фотографий. |
| `DELETE /api/announcements/{announcement}` | `auth:sanctum` + политика `delete` | Удаление объявления и связанных сущностей. |
| `POST /api/announcements/{announcement}/read` | `auth:sanctum` + политика `markRead` | Фиксация прочтения (создаёт/обновляет запись в `announcement_reads`). |

### Бизнес-логика
- Любой аутентифицированный пользователь видит объявления, но фильтрация по аудитории применяется автоматически: клиенты получают `audience in (all, clients)`, работники — `(all, workers)`. Администратор может дополнительно фильтровать выдачу по параметру `audience`.
- Для создания, редактирования и удаления требуется пользователь с ролью администратора (проверка делегирована в политики и FormRequest'ы).
- Вложения валидируются по типу (`jpg/jpeg/png/webp`) и размеру (до 5 МБ на файл, максимум 10 файлов).
- Метод `markRead` безопасно перезаписывает отметку чтения и может вызываться несколько раз.
- При разработке клиентской части учитывайте, что API возвращает стандартную пагинацию Laravel (`data`, `meta`, `links`).

## Кабинет клиента
- **Список задач**: карточки с прогрессом и кнопкой «добавить задачу», где клиент описывает детали и прикрепляет фото. Отдельная вкладка позволяет фильтровать задачи по статусу.
- **Чаты**: в клиентском профиле доступен диалог с админом и назначенным работником, поэтому все вопросы решаются без выхода из приложения.
- **Расписание и отчёты**: календарь показывает даты визитов, а экран «отчёт дня» содержит фото выполненных работ, комментарии от команды и поле для обратной связи.
- **Платежи**: карточка договора с суммами и комментариями, кнопка «создать» для подтверждения оплаты, таблица истории платежей по месяцам и годам.

## Панель бухгалтера
- **Разделы «график» и «оплата»**: бухгалтер видит календарь задач и все финансовые операции, может добавлять новые оплаты или редактировать существующие.
- **Экспорт и история**: доступ к тем же отчётам, что и у администратора, плюс возможность выгружать PDF с историей оплат.
- **Работа с клиентами**: список клиентов (K1…Kn); в карточке клиента фиксируются дата, сумма, комментарии к доп. работам и кнопка создания записи об оплате.

## Панель садовника
- **Лента задач**: блок «папка задания» показывает очередь назначенных задач и доп. поручений по клиентам. Каждая карточка ведёт в подробный экран с инструкцией.
- **Отчёт по задаче**: садовник фиксирует дату выполнения, прикрепляет фото «до/после», оставляет комментарий и нажимает кнопку «выполнил». Эти данные сразу улетают в отчёт дня и соответствующий чат.
- **Чаты**: отдельный раздел с диалогами `A+W` или `A+W+K`. Работник пишет сообщения и отправляет материалы, но не может менять участников или удалять чат.
- **Календарь**: виджет графика показывает, в какие дни нужно выходить на работу и какие дни свободны. Из календаря можно открыть список задач на конкретную дату.
- **Отчёты и объявления**: доступен экран «Отчёт дня» (фото, комментарии, статус), а также лента объявлений от администратора.

## Логика оплат
- **Карточка садовника**: при выборе сотрудника отображаются рабочие дни недели, базовая ставка/стоимость услуги (задана при создании) и параметры начислений (например, количество оплаченных дней и задач). Можно добавлять комментарии и сохранять изменения.
- **Модуль «Оплата»**: включает информацию об оплате клиента, вклад «внесение для работ» и отдельную вкладку «ЗП садовника», где фиксируются выплаты подрядчику.
- **Списки участников**: из блоков «список работников» и «список клиентов» переходят в карточки для назначения выплат, где указываются дата, сумма и комментарии к дополнительным задачам.
- **История и аналитика**: таблица по месяцам (январь–ноябрь) показывает динамику поступлений и задолженности; итоговые суммы сводятся в отдельный блок и могут отображаться в виде отчёта/таблицы.

## Основные сущности и атрибуты
| Сущность | Ключевые поля |
| --- | --- |
| `users` | `name`, `email`, `password`, `role` (worker/client/admin/accountant) |
| `orders` (будет создана) | `client_id`, `worker_id`, `description`, `images`, `payment_type`, `payment_money`, `status`, `due_date` |

> Вся логика должна придерживаться принятого в проекте стиля Laravel: Eloquent-модели, миграции с явными названиями, контроллеры в пространстве имён `App\Http\Controllers`.

## Технологический стек
- PHP 8.2+, Laravel 12, Sanctum для аутентификации.
- Vite и Laravel Mix стек по умолчанию из свежего шаблона.
- Очереди, кэш и Job-таблицы подготовлены базовыми миграциями.

## Планы развития
1. Создать модели/миграции для заказов и ролей пользователей.
2. Реализовать кабинет клиента с возможностью загружать фотографии и отслеживать статус.
3. Кабинет работника с очередью задач и отметками о выполнении.
4. Панель администратора для распределения задач и контроля SLA.
5. Модуль бухгалтерии: отчёты по оплатам, экспорт данных, подтверждение закрытия заказов.
6. Уведомления (email/чат) для ключевых событий.

## Локальный запуск
```bash
cp .env.example .env
composer install
php artisan key:generate
php artisan migrate
npm install
npm run dev
php artisan serve
```

## Подход к развитию документа
README служит живым документом: по мере появления новых модулей сюда будут добавляться разделы с описанием бизнес-логики, API, сценариев работы ролей и правилами тестирования. Предложения и уточнения фиксируйте прямо в этом файле, чтобы команда имела единый источник правды.
